---
import { getCollection } from 'astro:content';
import SectionHeader from "../ui/SectionHeader.astro";

const heading = "Testimonials";
const subHeading =
  "Hear from Our Satisfied Clients: Read Our Testimonials to Learn More about Our Digital Marketing Services";

const allTestimonials = await getCollection('testimonials');
const testimonials = allTestimonials
  .sort((a, b) => a.data.order - b.data.order)
  .map((t, index) => ({
    id: index + 1,
    ...t.data
  }));
---

<div class="h-auto mt-[3rem] w-full flex justify-center items-center">
  <div
    class="w-[88%] h-full flex flex-col items-center justify-center max-lg:gap-[1rem] rounded-t-3xl"
  >
    <SectionHeader heading={heading} subHeading={subHeading} />

    <div class="w-full bg-[#191A23] rounded-3xl mt-[3rem] px-4 sm:px-8 lg:px-12 py-8 sm:py-12 lg:py-16">
      <div class="overflow-hidden">
      <div id="testimonials-track" class="flex gap-8 transition-transform duration-500 ease-in-out">
        {testimonials.map((testimonial) => (
          <div class="min-w-[calc(100%-1rem)] md:min-w-[calc(55.333%-1.5rem)] flex flex-col">
            <div class="bg-[#191A23] border-2 border-heyOzGreen rounded-3xl p-8 relative">
              <p class="text-white leading-relaxed">
                "{testimonial.text}"
              </p>
              <div class="absolute -bottom-4 left-12 w-8 h-8 bg-[#191A23] border-b-2 border-r-2 border-heyOzGreen rotate-45"></div>
            </div>

            <div class="mt-8 ml-4">
              <p class="text-heyOzGreen font-medium text-lg">{testimonial.name}</p>
              <p class="text-white text-sm">{testimonial.position}</p>
            </div>
          </div>
        ))}
      </div>
      </div>

      <div class="flex justify-center items-center gap-8 mt-12">
        <button id="prev-btn" class="text-white hover:text-heyOzGreen transition-colors" aria-label="Previous testimonial">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>

        <div class="flex gap-3" id="dots-container">
          {testimonials.map((_, index) => (
            <button 
              class="indicator-dot transition-opacity hover:opacity-80" 
              data-index={index}
              aria-label={`Go to slide ${index + 1}`}
            >
              <img 
                src={index === 0 ? "/Vector-green.png" : "/Vector-white.png"} 
                alt="" 
                class="w-3 h-3"
              />
            </button>
          ))}
        </div>

        <button id="next-btn" class="text-white hover:text-heyOzGreen transition-colors" aria-label="Next testimonial">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentIndex = 0;
  const testimonials = document.querySelectorAll('#testimonials-track > div');
  const totalSlides = testimonials.length;
  const track = document.getElementById('testimonials-track');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const dots = document.querySelectorAll('.indicator-dot');

  function getSlideWidth() {
    return window.innerWidth < 768 ? 102 : 52;
  }

  function updateSlider() {
    const slideWidth = getSlideWidth();
    const translateX = -currentIndex * slideWidth;
    if (track) {
      track.style.transform = `translateX(${translateX}%)`;
    }

    dots.forEach((dot, index) => {
      const img = dot.querySelector('img');
      if (img) {
        if (index === currentIndex) {
          img.src = '/Vector-green.png';
        } else {
          img.src = '/Vector-white.png';
        }
      }
    });
  }

  function nextSlide() {
    currentIndex = (currentIndex + 1) % totalSlides;
    updateSlider();
  }

  function prevSlide() {
    currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
    updateSlider();
  }

  nextBtn?.addEventListener('click', nextSlide);
  prevBtn?.addEventListener('click', prevSlide);

  dots.forEach((dot) => {
    dot.addEventListener('click', () => {
      currentIndex = parseInt(dot.getAttribute('data-index') || '0');
      updateSlider();
    });
  });

  window.addEventListener('resize', updateSlider);
</script>